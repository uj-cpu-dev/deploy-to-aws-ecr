name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  ECR_REGION: us-east-1  # Replace with your AWS region
  IMAGE_REPO_NAME: my-app  # Replace with your ECR repository name

permissions:
  contents: read
  id-token: write
  packages: write
  actions: write

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: 3.9

      - name: Install Required Python Packages
        run: |
          python -m pip install --upgrade pip

      - name: Detect Project Type
        id: detect-project
        run: |
          python scripts/detect_language.py > project_type.txt
          language=$(cat project_type.txt)
          echo "language=$language" >> $GITHUB_ENV
        shell: bash

      - name: Build and Test for Node.js
        if: env.language == 'nodejs'
        run: |
          echo "Setting up Node.js environment..."
          sudo apt-get update
          curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
          sudo apt-get install -y nodejs
          node --version
          npm install
          npm run lint
          npm run test

      - name: Build and Test for Java
        if: env.language == 'java'
        run: |
          echo "Setting up Java environment..."
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jdk maven
          java --version
          mvn clean verify
